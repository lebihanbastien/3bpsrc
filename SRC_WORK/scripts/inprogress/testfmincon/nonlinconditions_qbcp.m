function [c,ceq] = nonlinconditions_qbcp(x0, yeml2, yseml2, t0, tf, N)

c   = x0(6*N+1) - x0(7*N);
ceq = zeros(6*(N-1)+6+2,1);

%--------------------------------------------------------------------------
% Equality conditions
%--------------------------------------------------------------------------
for k = 1:N-1
    % State at tk
    yk   = x0((k-1)*6+1:k*6);
    tk   = x0(6*N+k);
    
    % State at tk+1
    yk1  = x0(k*6+1:(k+1)*6);
    tk1  = x0(6*N+k+1); 
    
    %Integration
    [~,pyk] = ode78_qbcp([tk tk1], yk, 0, 1);
              
    %Equality conditions
    ceq((k-1)*6+1:k*6) = pyk(end,:)' - yk1;  
end

%--------------------------------------------------------------------------
% Departure at EML2
%--------------------------------------------------------------------------
% State at t1
y1 = x0(1:6);
ceq(6*(N-1)+1:6*(N-1)+3) = y1(1:3) - yeml2(1:3);

%--------------------------------------------------------------------------
% Arrival at Halo SEML2
%--------------------------------------------------------------------------
% State at tN
yN = x0((N-1)*6+1:N*6);
% Equality: tangential arrival
ceq(6*(N-1)+4:6*(N-1)+6) = yN(1:3) - yseml2(1:3);

%--------------------------------------------------------------------------
% Condition on time
%--------------------------------------------------------------------------
ceq(6*(N-1)+7) = x0(6*N+1) - t0;
ceq(6*(N-1)+8) = x0(7*N) - tf;

end

